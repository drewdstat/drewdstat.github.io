<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.39">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Drew Day, James Peng">
<meta name="dcterms.date" content="2022-05-26">

<title>How to use the wqspt package – Drew Day’s Website and Blog</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-e26003cea8cd680ca0c55a263523d882.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-bf19b75f51ea680c8de03e84aa65eabd.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Drew Day’s Website and Blog</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../research.html"> 
<span class="menu-text">My Research</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../blogposts.html"> 
<span class="menu-text">Statistics Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../pkgguides.html"> 
<span class="menu-text">My Packages</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../mountains.html"> 
<span class="menu-text">Mountaineering</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
    <a href="https://www.linkedin.com/in/drewbday" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-linkedin"></i></a>
    <a href="https://github.com/drewdstat/drewdstat.github.io" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-github"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a>
  <ul class="collapse">
  <li><a href="#about-wqs" id="toc-about-wqs" class="nav-link" data-scroll-target="#about-wqs">About WQS</a></li>
  <li><a href="#permutation-test" id="toc-permutation-test" class="nav-link" data-scroll-target="#permutation-test">Permutation Test</a>
  <ul class="collapse">
  <li><a href="#continuous-outcome-algorithm-linear-regression" id="toc-continuous-outcome-algorithm-linear-regression" class="nav-link" data-scroll-target="#continuous-outcome-algorithm-linear-regression">Continuous outcome algorithm (linear regression)</a></li>
  <li><a href="#binary-or-count-outcome-algorithms-generalized-linear-models-glms" id="toc-binary-or-count-outcome-algorithms-generalized-linear-models-glms" class="nav-link" data-scroll-target="#binary-or-count-outcome-algorithms-generalized-linear-models-glms">Binary or Count outcome algorithms (Generalized linear models (GLMs))</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#how-to-use-the-wqspt-package" id="toc-how-to-use-the-wqspt-package" class="nav-link" data-scroll-target="#how-to-use-the-wqspt-package">How to use the <code>wqspt</code> package</a>
  <ul class="collapse">
  <li><a href="#wqs_pt" id="toc-wqs_pt" class="nav-link" data-scroll-target="#wqs_pt"><code>wqs_pt</code></a>
  <ul class="collapse">
  <li><a href="#arguments" id="toc-arguments" class="nav-link" data-scroll-target="#arguments">Arguments</a></li>
  <li><a href="#outputs" id="toc-outputs" class="nav-link" data-scroll-target="#outputs">Outputs</a></li>
  <li><a href="#plotting-method" id="toc-plotting-method" class="nav-link" data-scroll-target="#plotting-method">Plotting method</a></li>
  </ul></li>
  <li><a href="#wqs_full_perm" id="toc-wqs_full_perm" class="nav-link" data-scroll-target="#wqs_full_perm"><code>wqs_full_perm</code></a></li>
  <li><a href="#recommendations-for-use" id="toc-recommendations-for-use" class="nav-link" data-scroll-target="#recommendations-for-use">Recommendations for Use</a></li>
  </ul></li>
  <li><a href="#examples" id="toc-examples" class="nav-link" data-scroll-target="#examples">Examples</a>
  <ul class="collapse">
  <li><a href="#example-1-using-wqs_pt" id="toc-example-1-using-wqs_pt" class="nav-link" data-scroll-target="#example-1-using-wqs_pt">Example 1 (using <code>wqs_pt</code>)</a></li>
  <li><a href="#example-2-using-wqs_pt" id="toc-example-2-using-wqs_pt" class="nav-link" data-scroll-target="#example-2-using-wqs_pt">Example 2 (using <code>wqs_pt</code>)</a></li>
  <li><a href="#example-3-using-wqs_full_perm" id="toc-example-3-using-wqs_full_perm" class="nav-link" data-scroll-target="#example-3-using-wqs_full_perm">Example 3 (using <code>wqs_full_perm</code>)</a></li>
  <li><a href="#example-4-using-wqs_full_perm-on-binary-outcome-example" id="toc-example-4-using-wqs_full_perm-on-binary-outcome-example" class="nav-link" data-scroll-target="#example-4-using-wqs_full_perm-on-binary-outcome-example">Example 4 (using <code>wqs_full_perm</code> on binary outcome example)</a></li>
  </ul></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references">References</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">How to use the wqspt package</h1>
  <div class="quarto-categories">
    <div class="quarto-category">wqspt</div>
  </div>
  </div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Drew Day, James Peng </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">May 26, 2022</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>Weighted quantile sum (WQS) regression is a statistical technique to evaluate the effect of complex exposure mixtures on an outcome (<a href="https://link.springer.com/article/10.1007/s13253-014-0180-3">Carrico 2015</a>). It is a single-index method which estimates a combined mixture sum effect as well as weights determining each individual mixture component’s contributions to the sum effect. However, the model features a statistical power and Type I error (i.e., false positive) rate tradeoff, as there is a machine learning step to determine the weights that optimize the linear model fit. If the full data is used to estimate both the mixture component weights and the regression coefficients, there is high power but also a high false positive rate since coefficient p-values are calculated for a weighted mixture independent variable with weights that have already been optimized to find a large effect.</p>
<p>We recently proposed alternative methods based on a permutation test that should reliably allow for both high power and low false positive rate when utilizing WQS regression. The permutation test is a method of obtaining a p-value by simulating the null distribution through permutations of the data. The permutation test algorithm is described more in detail and validated in <a href="https://ehp.niehs.nih.gov/doi/10.1289/EHP10570">Day et al.&nbsp;2022</a>. The version of this permutation test used for a continuous outcome variable has been applied in <a href="https://www.sciencedirect.com/science/article/pii/S0160412021000337">Loftus et al.&nbsp;2021</a>, <a href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC9291724/">Day et al.&nbsp;2021</a>, <a href="https://www.sciencedirect.com/science/article/pii/S0160412021006644">Wallace et al.&nbsp;2022</a>, <a href="https://www.sciencedirect.com/science/article/pii/S0160412022000034">Barrett et al.&nbsp;2022</a>, and <a href="https://www.sciencedirect.com/science/article/pii/S0160412022001726">Freije et al.&nbsp;2022</a>. Another version of the permutation test adapted for WQS logistic regression with a binary outcome variable is applied in <a href="https://www.sciencedirect.com/science/article/pii/S0160412022004214">Loftus et al.&nbsp;2022</a>.</p>
<section id="about-wqs" class="level2">
<h2 class="anchored" data-anchor-id="about-wqs">About WQS</h2>
<p>The goal of WQS regression is to determine whether an exposure mixture is associated with an outcome in a prespecified direction. It fits the following model:</p>
<p><span class="math inline">\(Y = \beta_0 + \beta_1(\sum_{i=1}^{m} w_i {X_q}_i) + Z'\gamma\)</span></p>
<p>Where <span class="math inline">\(Y\)</span> is the outcome variable, <span class="math inline">\(\beta_0\)</span> is the intercept, <span class="math inline">\(\beta_1\)</span> is the coefficient for the weighted quantile sum, <span class="math inline">\(\sum_{i=1}^{c} w_i {X_q}_i\)</span> is the weighted index for the set of quantiled mixture exposures, <span class="math inline">\(Z\)</span> is the set of covariates, and <span class="math inline">\(\gamma\)</span> is the regression coefficients for the covariates.</p>
<p>A full description of the WQS methodology is described in <a href="https://link.springer.com/article/10.1007/s13253-014-0180-3">Carrico 2015</a>.</p>
</section>
<section id="permutation-test" class="level2">
<h2 class="anchored" data-anchor-id="permutation-test">Permutation Test</h2>
<p>The WQS regression comprises two steps, for which we typically split the data into a training and validation set. Doing this reduces statistical power since we are training our model on only part of the data. On the other hand, if we skip this training/test split, we can get a skewed representation of uncertainty for the WQS coefficient. A permutation test method gives us a p-value for the uncertainty while also allowing us to use the full dataset for training and validation. This p-value is based on comparing a test value (e.g., coefficient or naive p-values) to iterated values, and so the minimum non-zero p-value that can be detected by the permutation test would be 1 divided by the number of permutation test iterations. For example, if we run 200 iterations, we’d be able to define a p-value of as low as 1/200 = 0.005, and any lower p-value would appear as zero and be interpreted as &lt;0.005.</p>
<section id="continuous-outcome-algorithm-linear-regression" class="level3">
<h3 class="anchored" data-anchor-id="continuous-outcome-algorithm-linear-regression">Continuous outcome algorithm (linear regression)</h3>
<ol type="1">
<li><p>Run WQS regression without splitting the data, obtaining a WQS coefficient estimate.</p></li>
<li><p>Regress the outcome on all covariates but not the WQS variable. Then obtain the predicted outcome values and their residuals from this regression.</p></li>
<li><p>Randomly permute the residual values and add them to the predicted outcome values to get a new outcome variable <span class="math inline">\(y*\)</span>.</p></li>
<li><p>Run a WQS regression without splitting the data in which <span class="math inline">\(y*\)</span> replaces the vector of observed outcome variables, obtaining an estimate for the WQS coefficient <span class="math inline">\(\beta_1^*\)</span>.</p></li>
<li><p>Repeat steps 3 and 4.</p></li>
<li><p>Calculate the p-value by taking the proportion of <span class="math inline">\(\beta_1^*\)</span> values greater than the WQS coefficient estimate obtained in Step 1.</p></li>
</ol>
</section>
<section id="binary-or-count-outcome-algorithms-generalized-linear-models-glms" class="level3">
<h3 class="anchored" data-anchor-id="binary-or-count-outcome-algorithms-generalized-linear-models-glms">Binary or Count outcome algorithms (Generalized linear models (GLMs))</h3>
<ol type="1">
<li><p>Regress each of the <span class="math inline">\(m\)</span> mixture components on all covariates <span class="math inline">\(Z\)</span> and obtain a <span class="math inline">\(n\)</span> observations x <span class="math inline">\(m\)</span> matrix with columns being the residuals from each of the <span class="math inline">\(m\)</span> models (<span class="math inline">\(R_{m|Z}\)</span>).</p></li>
<li><p>Obtain the initial fit (<span class="math inline">\(fit1\)</span>) by running a “non-split” WQS logistic regression (or other WQS GLM) in which the binary (or count) outcome variable <span class="math inline">\(Y\)</span> is regressed on the WQS vector and the covariates, and the mixture matrix used to calculate the WQS vector is the matrix of residuals from Step 1, <span class="math inline">\(R_{m|Z}\)</span>.</p></li>
<li><p>Obtain the reduced fit (<span class="math inline">\(fit2\)</span>) by running a logistic regression (or other GLM) regressing <span class="math inline">\(Y\)</span> on <span class="math inline">\(Z\)</span>.</p></li>
<li><p>Calculate the test p-value (<span class="math inline">\(p_t\)</span>) as <span class="math inline">\(1-pchisq(d(fit1)-d(fit2),1)\)</span> where d is the deviance for a given model and <span class="math inline">\(pchisq(x,1)\)</span> is the probability density function of the chi-square distribution in which the input <span class="math inline">\(x\)</span> is the difference between the deviances of <span class="math inline">\(fit1\)</span> and <span class="math inline">\(fit2\)</span> and there is 1 degree of freedom.</p></li>
<li><p>Permute the rows of the <span class="math inline">\(R_{m|Z}\)</span> residual matrix from Step 1 and repeat Step 2 to get a series of null fit1 models (<span class="math inline">\(fit1^*\)</span>) for K iterations. Obtain a distribution of permuted p-values (<span class="math inline">\(p^*\)</span>) using the following formula: <span class="math inline">\(p^*=1-pchisq(fit1^*)-d(fit2),1\)</span>).</p></li>
<li><p>Obtain the number of permuted <span class="math inline">\(p^*\)</span> less than or equal to the test <span class="math inline">\(p_t\)</span> from Step 4 and divide that by the number of iterations K to calculate the permutation test p-value.</p></li>
</ol>
<p>Note that the above algorithm has been validated in WQS logistic regressions but not yet for other forms of WQS GLMs (e.g., WQS Poisson regression). However, since deviances can also be derived from those models, the algorithm should work for those other WQS GLMs as well.</p>
</section>
</section>
</section>
<section id="how-to-use-the-wqspt-package" class="level1">
<h1>How to use the <code>wqspt</code> package</h1>
<p>The <code>wqspt</code> package builds from the <code>gWQS</code> package.</p>
<p>The two main functions of the <code>wqspt</code> package are <code>wqs_pt</code> and <code>wqs_full_perm</code>.</p>
<section id="wqs_pt" class="level2">
<h2 class="anchored" data-anchor-id="wqs_pt"><code>wqs_pt</code></h2>
<section id="arguments" class="level3">
<h3 class="anchored" data-anchor-id="arguments">Arguments</h3>
<p><code>wqs_pt</code> uses a <code>gwqs</code> object (from the <code>gWQS</code> <a href="https://CRAN.R-project.org/package=gWQS">package</a>) as an input. To use <code>wqs_pt</code>, we first need to run an initial <em>permutation test reference WQS regression</em> run while setting <code>validation = 0</code>. Note that permutation test can currently take in <code>gwqs</code> inputs with the following families: <code>family = gaussian(link = "identity")</code>, <code>family = binomial()</code> with any accepted link function (e.g., “logit” or “probit”), <code>family = poisson(link = "log")</code>, <code>family = quasipoisson(link = "log")</code>, and <code>family = "negbin"</code> for negative binomial. It is not currently able to accommodate multinomial WQS regression, stratified weights, or WQS interaction terms.</p>
<p>We will use this <code>gwqs</code> object as the <code>model</code> argument for the <code>wqs_pt</code> function and set the following additional parameters:</p>
<ul>
<li><code>boots</code>: Number of bootstraps for the WQS regression run in each permutation test iteration. Note that we may elect a bootstrap count <code>boots</code> lower than that specified in the <code>model</code> object for the sake of efficiency. If we do, <code>wqs_pt</code> will run the iterated WQS regressions for the permutation test with the number of bootstraps defined in <code>boots</code>. If <code>boots</code> is not specified, then the function will use the same bootstrap count in the permutation test iterated WQS regressions as that specified in the main WQS regression.</li>
<li><code>niter</code>: Number of permutation test iterations.</li>
<li><code>b1_pos</code>: A logical value that indicates whether beta values should be positive or negative.</li>
<li><code>rs</code>: A logical value indicating whether the random subset implementation for WQS should be performed (<a href="https://www.tandfonline.com/doi/abs/10.1080/03610918.2019.1577971?journalCode=lssp20">Curtin 2019</a>)</li>
<li><code>plan_strategy</code>: Evaluation strategy for the plan function (“sequential”, “transparent”, “multisession”, “multicore”, “multiprocess”, “cluster”, or “remote”). See the documentation for the future::plan function for full details.<br>
</li>
<li><code>seed</code>: Random seed for the permutation test WQS reference run</li>
</ul>
<p>The arguments <code>b1_pos</code> and <code>rs</code> should be consistent with the inputs chosen in the <code>model</code> object. The <code>seed</code> should ideally be consistent with the seed set in the <code>model</code> object, though this is not required.</p>
</section>
<section id="outputs" class="level3">
<h3 class="anchored" data-anchor-id="outputs">Outputs</h3>
<p>The permutation test returns an object of class <code>wqs_pt</code>, which contains three sublists:</p>
<ul>
<li><strong>perm_test</strong>
<ul>
<li><strong>pval</strong>: permutation test p-value</li>
<li><em>Linear WQS regression only</em></li>
<li><strong>testbeta</strong>: reference WQS coefficient <span class="math inline">\(\beta_1\)</span> value</li>
<li><strong>betas</strong>: a vector of <span class="math inline">\(\beta_1\)</span> values from each iteration of the permutation test</li>
<li><em>WQS GLM only</em></li>
<li><strong>testpval</strong>: test reference p-value</li>
<li><strong>permpvals</strong>: p-values from each iteration of the permutation test</li>
</ul></li>
<li><strong>gwqs_main</strong>: main gWQS object (same as <code>model</code> input)</li>
<li><strong>gwqs_perm</strong>: permutation test reference gWQS object (NULL if model <code>family != "gaussian"</code> or if same number of bootstraps are used in permutation test WQS regression runs as in the main run.)</li>
</ul>
</section>
<section id="plotting-method" class="level3">
<h3 class="anchored" data-anchor-id="plotting-method">Plotting method</h3>
<p>The <code>wqs_pt</code> class has a <code>wqspt_plot</code> method to help visualize and summarize WQS permutation test results. Plots include (1) a forest plot of the beta WQS coefficient with the naive confidence intervals as well as the permutation test p-value and (2) a heatmap of the WQS weights for each mixture component.</p>
</section>
</section>
<section id="wqs_full_perm" class="level2">
<h2 class="anchored" data-anchor-id="wqs_full_perm"><code>wqs_full_perm</code></h2>
<p>The second function <code>wqs_full_perm</code> is a full wrapper which implements the initial WQS regression run using gWQS::gwqs and the permutation test in one function call.</p>
<p>To use <code>wqs_full_perm</code>, you must specify the same required arguments as needed in the <code>gwqs</code> call. This function can run WQS regressions and the permutation test for the following families: <code>family = gaussian(link = "identity")</code>, <code>family = binomial()</code> with any accepted link function (e.g., “logit” or “probit”), <code>family = poisson(link = "log")</code>, <code>family = quasipoisson(link = "log")</code>, and <code>family = "negbin"</code> for negative binomial. <code>wqs_full_perm</code>is not currently able to accommodate multinomial WQS regression, stratified weights, or WQS interaction terms.</p>
<p>For the bootstrap count <code>b</code> argument, you must specify <code>b_main</code>,the number of bootstraps for the <em>main WQS regression</em> run, as well as <code>b_perm</code>, the number of bootstraps for the <em>permutation test reference WQS regression</em> run (linear WQS regression only) and each WQS regression iteration of the permutation test. As with before, you can choose to set <code>b_main</code> <span class="math inline">\(&gt;\)</span> <code>b_perm</code> for the sake of efficiency. Finally, you should indicate the number of desired permutation test runs <code>niter</code>.</p>
<p>Since the WQS permutation test can be computationally intensive, you can specify <code>stop_if_nonsig = TRUE</code> if you do not wish for the permutation test to proceed if the naive main WQS regression run produces an nonsignificant result (if the p-value is below the <code>stop_thresh</code> argument, for which the default is 0.05). See <em>Recommendations for Use</em> section below.</p>
<p>The <code>wqs_full_perm</code> returns an object of class <code>wqs_pt</code>, with outputs described above.</p>
</section>
<section id="recommendations-for-use" class="level2">
<h2 class="anchored" data-anchor-id="recommendations-for-use">Recommendations for Use</h2>
<p>Larger bootstrap counts and numbers of iterations lead to better estimates, though it is unclear how many iterations or bootstraps are needed for a stable estimate. We generally recommend using 1000 bootstraps on the main WQS regression and then performing 200 iterations of 200-boostrap WQS regressions for the permutation test. However, this takes a substantial amount of computational time, and one could also get relatively stable p-values for instance for 100 iterations of 100-boostrap WQS regressions for the permutation test.</p>
<p>We recommend that users only apply the permutation test in cases where the naive WQS test approaches significance or near-significance. If the naive test produces a non-significant result, then there likely is no reason to run the permutation test, as it will produce a result which is more conservative than the naive method (i.e., it will have a larger p-value). This is the strategy that we have applied in our published papers (<a href="https://www.sciencedirect.com/science/article/pii/S0160412021000337">Loftus et al.&nbsp;2021</a> and <a href="https://www.sciencedirect.com/science/article/pii/S0160412020322856">Day et al.&nbsp;2021</a>).</p>
</section>
</section>
<section id="examples" class="level1">
<h1>Examples</h1>
<section id="example-1-using-wqs_pt" class="level2">
<h2 class="anchored" data-anchor-id="example-1-using-wqs_pt">Example 1 (using <code>wqs_pt</code>)</h2>
<p>This is an example where the WQS permutation test confirms a significant naive result.</p>
<p>We first load both the wqspt and gWQS packages.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gWQS)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(wqspt)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then we produce a simulated dataset with the following parameters:</p>
<ul>
<li>WQS coefficient <span class="math inline">\(\beta_1\)</span>: 0.2</li>
<li>Mixture weights: 0.15 for first 5 components, 0.05 for remaining 5 components</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># simulated dataset</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>sim_res1 <span class="ot">&lt;-</span> <span class="fu">wqs_sim</span>(<span class="at">nmix =</span> <span class="dv">10</span>,</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>                    <span class="at">ncovrt =</span> <span class="dv">10</span>,</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>                    <span class="at">nobs =</span> <span class="dv">1000</span>,</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>                    <span class="at">ntruewts =</span> <span class="dv">10</span>, </span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>                    <span class="at">ntruecovrt =</span> <span class="dv">5</span>, </span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>                    <span class="at">truewqsbeta =</span> <span class="fl">0.2</span>, </span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>                    <span class="at">truebeta0 =</span> <span class="dv">2</span>, </span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>                    <span class="at">truewts =</span> <span class="fu">c</span>(<span class="fl">0.15</span>, <span class="fl">0.15</span>, <span class="fl">0.15</span>, <span class="fl">0.15</span>, <span class="fl">0.15</span>,</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>                                <span class="fl">0.05</span>, <span class="fl">0.05</span>, <span class="fl">0.05</span>, <span class="fl">0.05</span>, <span class="fl">0.05</span>), </span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>                    <span class="at">q =</span> <span class="dv">10</span>, </span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>                    <span class="at">seed =</span> <span class="dv">16</span>)</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>sim_data1 <span class="ot">&lt;-</span> sim_res1<span class="sc">$</span>Data</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>wqs_form <span class="ot">&lt;-</span> <span class="fu">formula</span>(<span class="fu">paste0</span>(<span class="st">"y ~ wqs + "</span>, <span class="fu">paste</span>(<span class="fu">paste0</span>(<span class="st">"C"</span>,<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>), <span class="at">collapse=</span><span class="st">"+"</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we run WQS regression on the simulated data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># mixture names</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>mix_names1 <span class="ot">&lt;-</span> <span class="fu">colnames</span>(sim_data1)[<span class="dv">2</span><span class="sc">:</span><span class="dv">11</span>]</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co"># create reference wqs object</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>wqs_main1 <span class="ot">&lt;-</span> <span class="fu">gwqs</span>(wqs_form, <span class="at">mix_name =</span> mix_names1, <span class="at">data =</span> sim_data1, <span class="at">q =</span> <span class="dv">10</span>, <span class="at">validation =</span> <span class="dv">0</span>,</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>                  <span class="at">b =</span> <span class="dv">20</span>, <span class="at">b1_pos =</span> T, <span class="at">plan_strategy =</span> <span class="st">"multicore"</span>, <span class="at">family =</span> <span class="st">"gaussian"</span>, </span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>                  <span class="at">seed =</span> <span class="dv">16</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Finally, we can perform a permutation test on the WQS object.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># run permutation test</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>perm_test_res1 <span class="ot">&lt;-</span> <span class="fu">wqs_pt</span>(wqs_main1, <span class="at">niter =</span> <span class="dv">50</span>, <span class="at">boots =</span> <span class="dv">5</span>, <span class="at">b1_pos =</span> T, <span class="at">seed =</span> <span class="dv">16</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note that the naive WQS regression produces a significant result for the WQS coefficient (p-value &lt; 0.001).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>main_sum1 <span class="ot">&lt;-</span> <span class="fu">summary</span>(perm_test_res1<span class="sc">$</span>gwqs_main)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>main_sum1<span class="sc">$</span>coefficients</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;                 Estimate Std. Error     t value      Pr(&gt;|t|)</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; (Intercept)  1.716588215 0.13195745  13.0086490  7.960621e-36</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; wqs          0.271247707 0.02846484   9.5292204  1.183377e-20</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; C1           0.915972918 0.03235401  28.3109569 1.372658e-129</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; C2           1.837398541 0.03166084  58.0337820 1.460458e-320</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; C3          -1.567906582 0.03096844 -50.6291836 9.835375e-277</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; C4          -0.261844308 0.03025602  -8.6542893  1.987022e-17</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; C5          -0.350600283 0.03111404 -11.2682323  8.594271e-28</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; C6           0.017181769 0.03214707   0.5344739  5.931340e-01</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; C7           0.028020482 0.03007333   0.9317386  3.516993e-01</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; C8           0.006594393 0.03040937   0.2168540  8.283669e-01</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; C9          -0.075174923 0.03029635  -2.4813194  1.325512e-02</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; C10         -0.003960226 0.03079737  -0.1285898  8.977084e-01</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The permutation test confirms the significance of this result.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>perm_test_res1<span class="sc">$</span>perm_test<span class="sc">$</span>pval</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] 0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here are the summary plots:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">wqspt_plot</span>(perm_test_res1)<span class="sc">$</span>FullPlot</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Warning in get_plot_component(plot, "guide-box"): Multiple components found;</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; returning the first one. To return all, use `return_all = TRUE`.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="wqspt_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="example-2-using-wqs_pt" class="level2">
<h2 class="anchored" data-anchor-id="example-2-using-wqs_pt">Example 2 (using <code>wqs_pt</code>)</h2>
<p>This is an example where the WQS permutation test goes against a (false positive) significant naive result.</p>
<p>We produce a simulated dataset with the following parameters:</p>
<ul>
<li>WQS coefficient <span class="math inline">\(\beta_1\)</span>: 0</li>
<li>Mixture weights: 0.15 for first 5 components, 0.05 for remaining 5 components</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>sim_res2 <span class="ot">&lt;-</span> <span class="fu">wqs_sim</span>(<span class="at">nmix =</span> <span class="dv">10</span>,</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>                    <span class="at">ncovrt =</span> <span class="dv">10</span>,</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>                    <span class="at">nobs =</span> <span class="dv">1000</span>,</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>                    <span class="at">ntruewts =</span> <span class="dv">10</span>, </span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>                    <span class="at">ntruecovrt =</span> <span class="dv">5</span>, </span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>                    <span class="at">truewqsbeta =</span> <span class="dv">0</span>, </span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>                    <span class="at">truebeta0 =</span> <span class="fl">0.1</span>, </span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>                    <span class="at">truewts =</span> <span class="fu">c</span>(<span class="fl">0.15</span>, <span class="fl">0.15</span>, <span class="fl">0.15</span>, <span class="fl">0.15</span>, <span class="fl">0.15</span>,</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>                                <span class="fl">0.05</span>, <span class="fl">0.05</span>, <span class="fl">0.05</span>, <span class="fl">0.05</span>, <span class="fl">0.05</span>), </span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>                    <span class="at">q =</span> <span class="dv">10</span>, </span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>                    <span class="at">seed =</span> <span class="dv">16</span>)</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>sim_data2 <span class="ot">&lt;-</span> sim_res2<span class="sc">$</span>Data</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we run WQS regression as well as the permutation test on the simulated data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># mixture names</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>mix_names2 <span class="ot">&lt;-</span> <span class="fu">colnames</span>(sim_data2)[<span class="dv">2</span><span class="sc">:</span><span class="dv">11</span>]</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="co"># create reference wqs object</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>wqs_main2 <span class="ot">&lt;-</span> <span class="fu">gwqs</span>(wqs_form, <span class="at">mix_name =</span> mix_names2, <span class="at">data =</span> sim_data2, <span class="at">q =</span> <span class="dv">10</span>, <span class="at">validation =</span> <span class="dv">0</span>,</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>                  <span class="at">b =</span> <span class="dv">20</span>, <span class="at">b1_pos =</span> T, <span class="at">plan_strategy =</span> <span class="st">"multicore"</span>, <span class="at">family =</span> <span class="st">"gaussian"</span>, </span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>                  <span class="at">seed =</span> <span class="dv">16</span>)</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a><span class="co"># run permutation test</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>perm_test_res2 <span class="ot">&lt;-</span> <span class="fu">wqs_pt</span>(wqs_main2, <span class="at">niter =</span> <span class="dv">50</span>, <span class="at">boots =</span> <span class="dv">5</span>, <span class="at">b1_pos =</span> T, <span class="at">seed =</span> <span class="dv">16</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note that the naive WQS regression produces a significant result for the WQS coefficient (p-value = 0.002).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>main_sum2 <span class="ot">&lt;-</span> <span class="fu">summary</span>(perm_test_res2<span class="sc">$</span>gwqs_main)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>main_sum2<span class="sc">$</span>coefficients</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;                 Estimate Std. Error     t value      Pr(&gt;|t|)</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; (Intercept) -0.242259146 0.12595439  -1.9233879  5.471846e-02</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; wqs          0.084337304 0.02709982   3.1120982  1.910997e-03</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; C1           0.916079837 0.03236572  28.3040164 1.530151e-129</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; C2           1.836539134 0.03166066  58.0069707 2.079028e-320</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; C3          -1.568725043 0.03099602 -50.6105377 1.279103e-276</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; C4          -0.260464045 0.03027002  -8.6046855  2.973949e-17</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; C5          -0.350431787 0.03114219 -11.2526386  1.005351e-27</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; C6           0.016352846 0.03216484   0.5084075  6.112811e-01</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; C7           0.027852144 0.03008416   0.9258077  3.547720e-01</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; C8           0.006968031 0.03042095   0.2290537  8.188746e-01</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; C9          -0.074755354 0.03031780  -2.4657251  1.384261e-02</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; C10         -0.003661685 0.03081250  -0.1188377  9.054281e-01</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The permutation test, however, repudiates the significance of these plots (p = 0.12).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>perm_test_res2<span class="sc">$</span>perm_test<span class="sc">$</span>pval</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] 0.12</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here are the summary plots:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">wqspt_plot</span>(perm_test_res2)<span class="sc">$</span>FullPlot</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Warning in get_plot_component(plot, "guide-box"): Multiple components found;</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; returning the first one. To return all, use `return_all = TRUE`.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="wqspt_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="example-3-using-wqs_full_perm" class="level2">
<h2 class="anchored" data-anchor-id="example-3-using-wqs_full_perm">Example 3 (using <code>wqs_full_perm</code>)</h2>
<p>Using the same data as in Example 1, we run the WQS regression with permutation test using the full wrapper <code>wqs_full_perm</code> call.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>perm_test_res3 <span class="ot">&lt;-</span> <span class="fu">wqs_full_perm</span>(wqs_form,</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>                               <span class="at">data =</span> sim_data1,</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>                               <span class="at">mix_name =</span> mix_names1,</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>                               <span class="at">q =</span> <span class="dv">10</span>,</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>                               <span class="at">b_main =</span> <span class="dv">20</span>,</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>                               <span class="at">b_perm =</span> <span class="dv">5</span>,</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>                               <span class="at">b1_pos =</span> T,</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>                               <span class="at">niter =</span> <span class="dv">50</span>,</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>                               <span class="at">seed =</span> <span class="dv">16</span>,</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>                               <span class="at">plan_strategy =</span> <span class="st">"multicore"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">wqspt_plot</span>(perm_test_res3)<span class="sc">$</span>FullPlot</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Warning in get_plot_component(plot, "guide-box"): Multiple components found;</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; returning the first one. To return all, use `return_all = TRUE`.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="wqspt_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="example-4-using-wqs_full_perm-on-binary-outcome-example" class="level2">
<h2 class="anchored" data-anchor-id="example-4-using-wqs_full_perm-on-binary-outcome-example">Example 4 (using <code>wqs_full_perm</code> on binary outcome example)</h2>
<p>This is an example in which we apply the logistic regression version of the WQS permutation test.</p>
<p>We produce a simulated dataset with the following parameters:</p>
<ul>
<li>WQS coefficient <span class="math inline">\(\beta_1\)</span>: 0.4</li>
<li>Mixture weights: 0.15 for first 5 components, 0.05 for remaining 5 components</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>sim_res3 <span class="ot">&lt;-</span> <span class="fu">wqs_sim</span>(<span class="at">nmix =</span> <span class="dv">10</span>,</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>                    <span class="at">ncovrt =</span> <span class="dv">10</span>,</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>                    <span class="at">nobs =</span> <span class="dv">1000</span>,</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>                    <span class="at">ntruewts =</span> <span class="dv">10</span>, </span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>                    <span class="at">ntruecovrt =</span> <span class="dv">5</span>, </span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>                    <span class="at">truewqsbeta =</span> <span class="fl">0.4</span>, </span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>                    <span class="at">truebeta0 =</span> <span class="sc">-</span><span class="fl">2.5</span>, </span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>                    <span class="at">truewts =</span> <span class="fu">c</span>(<span class="fl">0.15</span>, <span class="fl">0.15</span>, <span class="fl">0.15</span>, <span class="fl">0.15</span>, <span class="fl">0.15</span>,</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>                                <span class="fl">0.05</span>, <span class="fl">0.05</span>, <span class="fl">0.05</span>, <span class="fl">0.05</span>, <span class="fl">0.05</span>), </span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>                    <span class="at">q =</span> <span class="dv">10</span>, </span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>                    <span class="at">family =</span> <span class="st">"binomial"</span>,</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>                    <span class="at">seed =</span> <span class="dv">16</span>)</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>sim_data3 <span class="ot">&lt;-</span> sim_res3<span class="sc">$</span>Data</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>perm_test_res4 <span class="ot">&lt;-</span> <span class="fu">wqs_full_perm</span>(wqs_form,</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>                               <span class="at">data =</span> sim_data3,</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>                               <span class="at">mix_name =</span> mix_names1,</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>                               <span class="at">q =</span> <span class="dv">10</span>,</span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>                               <span class="at">b_main =</span> <span class="dv">20</span>,</span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>                               <span class="at">b_perm =</span> <span class="dv">5</span>,</span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>                               <span class="at">b1_pos =</span> T,</span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>                               <span class="at">niter =</span> <span class="dv">50</span>,</span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>                               <span class="at">seed =</span> <span class="dv">16</span>,</span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>                               <span class="at">plan_strategy =</span> <span class="st">"multicore"</span>,</span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>                               <span class="at">family =</span> <span class="st">"binomial"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">wqspt_plot</span>(perm_test_res4)<span class="sc">$</span>FullPlot</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Warning in get_plot_component(plot, "guide-box"): Multiple components found;</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; returning the first one. To return all, use `return_all = TRUE`.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="wqspt_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="references" class="level1">
<h1>References</h1>
<ul>
<li><p>Barrett, E. S., Corsetti, M., Day, D., Thurston, S. W., Loftus, C. T., Karr, C. J., … &amp; Sathyanarayana, S. (2022). Prenatal phthalate exposure in relation to placental corticotropin releasing hormone (pCRH) in the CANDLE cohort. Environment International, 160, 107078.</p></li>
<li><p>Carrico, C., Gennings, C., Wheeler, D. C., &amp; Factor-Litvak, P. (2015). Characterization of weighted quantile sum regression for highly correlated data in a risk analysis setting. Journal of Agricultural, Biological, and Environmental Statistics, 20(1), 100-120.</p></li>
<li><p>Curtin, P., Kellogg, J., Cech, N., &amp; Gennings, C. (2019). A random subset implementation of weighted quantile sum (WQSRS) regression for analysis of high-dimensional mixtures. Communications in Statistics-Simulation and Computation, 50(4), 1119-1134.</p></li>
<li><p>Day, D. B., Collett, B. R., Barrett, E. S., Bush, N. R., Swan, S. H., Nguyen, R. H., … &amp; Sathyanarayana, S. (2021). Phthalate mixtures in pregnancy, autistic traits, and adverse childhood behavioral outcomes. Environment International, 147, 106330.</p></li>
<li><p>Day, D. B., Sathyanarayana, S., LeWinn, K. Z., Karr, C. J., Mason, W. A., &amp; Szpiro, A. A. (2022). A permutation test-based approach to strengthening inference on the effects of environmental mixtures: comparison between single index analytic methods. Environmental Health Perspectives, 130(8).</p></li>
<li><p>Freije, S. L., Enquobahrie, D. A., Day, D. B., Loftus, C., Szpiro, A. A., Karr, C. J., … &amp; Sathyanarayana, S. (2022). Prenatal exposure to polycyclic aromatic hydrocarbons and gestational age at birth. Environment International, 164, 107246.</p></li>
<li><p>Loftus, C. T., Bush, N. R., Day, D. B., Ni, Y., Tylavsky, F. A., Karr, C. J., … &amp; LeWinn, K. Z. (2021). Exposure to prenatal phthalate mixtures and neurodevelopment in the Conditions Affecting Neurocognitive Development and Learning in Early childhood (CANDLE) study. Environment International, 150, 106409.</p></li>
<li><p>Loftus, C., Szpiro, A. A., Workman, T., Wallace, E. R., Hazlehurst, M. F., Day, D. B., … &amp; Karr, C. J. (2022). Maternal exposure to urinary polycyclic aromatic hydrocarbons (PAH) in pregnancy and childhood asthma in a pooled multi-cohort study. Environment International, 170, p.107494.</p></li>
<li><p>Renzetti, S., Curtin, P., Just, A. C., Bello, G., &amp; Gennings, C. (2021). ‘gWQS: Generalized Weighted Quantile Sum Regression’. https://CRAN.R-project.org/package=gWQS.</p></li>
<li><p>Wallace, E. R., Ni, Y., Loftus, C. T., Sullivan, A., Masterson, E., Szpiro, A., … &amp; Sathyanarayana, S. (2022). Prenatal urinary metabolites of polycyclic aromatic hydrocarbons and toddler cognition, language, and behavior. Environment International, 159, 107039.</p></li>
</ul>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/drewdstat\.github\.io");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p>© Copyright 2025, Drew Day</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
<p>Built with <a href="https://quarto.org/">Quarto</a></p>
</div>
  </div>
</footer>




</body></html>